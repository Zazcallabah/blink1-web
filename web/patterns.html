<!DOCTYPE html>
<html>
<head>
	<title>Blink(1) - patterns</title>
	<script type="text/javascript" src="raphael.js" charset="utf-8"></script>
	<script type="text/javascript" src="colorpicker.js" charset="utf-8"></script>
	<script type="text/javascript" src="knockout.js" charset="utf-8"></script>
	<script type="text/javascript" src="api.js" charset="utf-8"></script>
	<script type="text/javascript" src="presets.js" charset="utf-8"></script>
	<style type="text/css">
		input{
			width: 40px
		}
	</style>

	<script type="text/javascript">
var hexconvert = function(num){
	var res = num.toString(16);
	if( num <= 0xf )
		return "0"+res;
	return res;
};
	

	
	var api = new Api();
	var picker = undefined;
	
	function Pattern(source){
		if( !source )
			source ={};
		this.r = ko.observable(0);
		this.g = ko.observable(0);
		this.b = ko.observable(0);
		this.setColors( source.color || "#000000" );
		this.ledn = ko.observable(source.ledn || 0);
		this.time = ko.observable(source.time || 0);
		this.index = ko.observable(source.index || 0);
		this.color = ko.computed(function(){
			return "#"+hexconvert(this.r())
			+hexconvert(this.g())
			+hexconvert(this.b());
		},this);
	};
	
	Pattern.prototype.grabColorFromPicker=function(){
		this.setColors(picker.latestColor);
	};
	
	Pattern.prototype.setColors = function(color){
		this.r(parseInt(color.substr(1,2),16));
		this.g(parseInt(color.substr(3,2),16));
		this.b(parseInt(color.substr(5,2),16));
	};
	

	Pattern.prototype.toObject = function(){
		return {
			color: "#" + 
				hexconvert(this.r()) + 
				hexconvert(this.g()) + 
				hexconvert(this.b()),
			ledn: this.ledn(),
			time: this.time(),
			index: this.index()
		};
	};
	
	var model = {
		patterns: ko.observableArray([]),
		selected: ko.observable(),
		presets: ko.observableArray(presets)
	};
	
	model.selected.subscribe(function(s){
		var startindex = 32-s.lines.length;
		for( var i = 0;i<s.lines.length; i++ )
		{
			
			model.patterns()[startindex+i].setColors( s.lines[i].color );
			model.patterns()[startindex+i].ledn( s.lines[i].ledn );
			model.patterns()[startindex+i].time( s.lines[i].time );
		}
	});

	window.onload = function() {
		picker = new Pick( "colorpicker" );
		for(var i=0;i<32;i++)
		{
			model.patterns.push(new Pattern({color:"#000000",ledn:0,time:0,index:i}));
		}
	/*	api.readPatterns(function(p){
			model.patterns(p.map( function(ps){ return new Pattern(ps); } ) );
		});
		*/
		ko.applyBindings(model);
	};
	</script>
</head>

<body style="margin-top: 350px">
<select data-bind="value:selected, options:presets, optionsText:'name', optionsCaption: 'Presets'"></select>
<ol start="0" data-bind="foreach: patterns">
	<li>
		<button data-bind="click: grabColorFromPicker">Grab</button> <span data-bind="style:{background:color()}" style="width:10px">&nbsp;</span>
		R: <input data-bind="value: r" />
		G: <input data-bind="value: g" />
		B: <input data-bind="value: b" />
		<select data-bind="value: ledn" >
			<option value="0">Both leds</option> 
			<option value="1">Led A</option> 
			<option value="2">Led B</option>
		</select> | 
		<input data-bind="value: time" /> ms
	</li>
</ol>

	<div id="colorpicker" style="width:300px; height:300px; position:absolute; top:0; left:0"></div>

</body>
</html>
