<!DOCTYPE html>
<html>
<head>
	<title>Blink(1)</title>
	<script type="text/javascript" src="raphael.js" charset="utf-8"></script>
	<script type="text/javascript" src="colorpicker.js" charset="utf-8"></script>
	<style type="text/css">
		.outline {
			text-shadow:
			-1px -1px 0 #000,
			1px -1px 0 #000,
			-1px 1px 0 #000,
			1px 1px 0 #000;  
		}
		button {
			font-size: 1.5em;
			padding: 1.1em 1.4em;
		}
	</style>

	<script type="text/javascript">
	function go(str)
	{
		if( window.location.hash === "#debug" ) {
			document.getElementById("result").innerHTML = "DEBUG SENT: "+str;
			return false;
		}
		
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == XMLHttpRequest.DONE ) {
				 document.getElementById("result").innerHTML = xmlhttp.responseText;
			}
		}		
		xmlhttp.open("POST", "/api", true);
		xmlhttp.send( str || document.getElementById("cmd").value);
		return false;
	}
	
	function Pick( id, index )
	{
		var that = this;
		this.colorPicker = Raphael.colorpicker( document.getElementById(id) );
		var buffering = false;
		this.latestColor = "";
		var send = function() {
			go( "-l "+index+" -m 1 --rgb=" + that.latestColor );
			buffering = false;
		};
		this.colorPicker.onchange = function (clr) {
			that.latestColor = clr;
			if( !buffering ) {
				buffering = true;
				// don't spam a web request for each event.
				// instead we buffer for 100 ms and then send the latest value
				window.setTimeout(send, 100);
			}
		};
	}
	
	function setColor( c ) {
		var selected = document.ledchoice.led.value;
		var l = "";
		if( selected === "led1" )
			l = "-l 1 ";
		else if( selected === "led2" )
			l = "-l 2 ";
		
		go(l+c);
	}
	
	var readColor( str ){
		var c1 = str.substring(0,6);
		var c2 = str.substring(7,14);
		document.getElementById("l1").style.borderColor = "#"+c1
		document.getElementById("l2").style.borderColor = "#"+c2
	};
	
	var updateCurrent = function(){
		if( window.location.hash === "#debug" ) {
			return;
		}
		
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == XMLHttpRequest.DONE ) {
				readColor( xmlhttp.responseText );
				window.setTimeout( updateCurrent, 1000 );
			}
		}		
		xmlhttp.open("GET", "/api", true);
		xmlhttp.send( "" );
	};

	window.onload = function() {
		if( window.location.search.length > 1 )
			go( decodeURI( window.location.search.substring(1) ) );
		
		var p1 = new Pick( "l1", 1 );
		var p2 = new Pick( "l2", 2 );
	};
	</script>
</head>

<body style="margin-top: 350px">

	<form onsubmit="return go()">
		<input id="cmd" />
		<input type="submit" value="Go">
	</form>
	
	<form name="ledchoice" style="float:left; margin:1em">
		<input type="radio" name="led" value="both" id="ledchoiceboth" checked="checked" /> <label for="ledchoiceboth">Both</label><br/>
		<input type="radio" name="led" value="led1" id="ledchoice1" /> <label for="ledchoice1">Side A</label><br/>
		<input type="radio" name="led" value="led2" id="ledchoice2" /> <label for="ledchoice2">Side B</label>
	</form>

	<p>
		<button onclick="setColor('--off')">Off</button>
		<button onclick="setColor('--on')" class="outline" style="color:white">White</button>
		<button onclick="setColor('--red')" style="color:red">Red</button>
		<button onclick="setColor('--green')" style="color:green">Green</button>
		<button onclick="setColor('--blue')" style="color:blue">Blue</button>
		<button onclick="setColor('--cyan')" class="outline" style="color:cyan">Cyan</button>
		<button onclick="setColor('--magenta')" style="color:magenta">Magenta</button>
		<button onclick="setColor('--yellow')" class="outline" style="color:yellow">Yellow</button>
	</p>

	<pre style="clear:both" id="result"></pre>

	<div id="l1" style="width:300px; height:300px; position:absolute; top:0; left:0; border-bottom: 5px solid white"></div>
	<div id="l2" style="width:300px; height:300px; position:absolute; top:0; right:0; border-bottom: 5px solid white"></div>

	</body>
</html>
