<!DOCTYPE html>
<html>
<head>
	<title>Blink(1)</title>
	<script type="text/javascript" src="raphael.js" charset="utf-8"></script>
	<script type="text/javascript" src="colorpicker.js" charset="utf-8"></script>
	<style type="text/css">
		.outline {
			text-shadow:
			-1px -1px 0 #000,
			1px -1px 0 #000,
			-1px 1px 0 #000,
			1px 1px 0 #000;  
		}
		button {
			font-size: 1.5em;
			padding: 1.1em 1.4em;
		}
	</style>

	<script type="text/javascript">
	function Api(){
		// callback param: {ledA:"#000000",ledB:"#000000"}
		this.getCurrentColor = function(callback){ 
			var xmlhttp = new XMLHttpRequest();
			xmlhttp.onreadystatechange = function() {
				if (xmlhttp.readyState == XMLHttpRequest.DONE )
					callback( JSON.parse(xmlhttp.responseText) );
			}
			xmlhttp.open("GET", "/api", true);
			xmlhttp.send( "" );
		};
		
		// ledn = {0,1,2}, time in ms, color is hexcolor
		this.fadeToColor = function(ledn,time,color){
			var xmlhttp = new XMLHttpRequest();
			xmlhttp.onreadystatechange = function() {
				if (xmlhttp.readyState == XMLHttpRequest.DONE ) {
					document.getElementById("result").innerHTML = xmlhttp.responseText;
				}
			}
			xmlhttp.open("POST", "/api", true);
			xmlhttp.send( JSON.stringify({ledn: ledn, time: time, color: color}) );
		};
	};
	
	function Pick( id, index, api )
	{
		var that = this;
		this.colorPicker = Raphael.colorpicker( document.getElementById(id) );
		var buffering = false;
		this.latestColor = "";
		var send = function() {
			api.fadeToColor( index, 1 , that.latestColor );
			buffering = false;
		};
		this.colorPicker.onchange = function (clr) {
			that.latestColor = clr;
			if( !buffering ) {
				buffering = true;
				// don't spam a web request for each event.
				// instead we buffer for 100 ms and then send the latest value
				window.setTimeout(send, 100);
			}
		};
	}
	
	var api = new Api();
	
	function setColor( c ) {
		var selected = document.ledchoice.led.value;
		var l = 0;
		if( selected === "led1" )
			l = 1;
		else if( selected === "led2" )
			l = 2;
		var color = c;
		if( c === "red" )
			color = "#FF0000";
		else if( c === "green" )
			color = "#00FF00";
		else if( c === "blue" )
			color = "#0000FF";
		else if( c === "cyan" )
			color = "#00FFFF";
		else if( c === "magenta" )
			color = "#FF00FF";
		else if( c === "yellow" )
			color = "#FFFF00";
		else if( c === "off" )
			color = "#000000";
		else if( c === "on" )
			color = "#FFFFFF";

		api.fadeToColor( l, 1, color );
	}
	

	var updateCurrent = function(){
		if( window.location.hash === "#debug" ) {
			return;
		}
		
		
	};

	window.onload = function() {
		if( window.location.search.length > 1 )
			go( decodeURI( window.location.search.substring(1) ) );
		
		var p1 = new Pick( "l1", 1, api );
		var p2 = new Pick( "l2", 2, api );
	};
	</script>
</head>

<body style="margin-top: 350px">

	<form name="ledchoice" style="float:left; margin:1em">
		<input type="radio" name="led" value="both" id="ledchoiceboth" checked="checked" /> <label for="ledchoiceboth">Both</label><br/>
		<input type="radio" name="led" value="led1" id="ledchoice1" /> <label for="ledchoice1">Side A</label><br/>
		<input type="radio" name="led" value="led2" id="ledchoice2" /> <label for="ledchoice2">Side B</label>
	</form>

	<p>
		<button onclick="setColor('--off')">Off</button>
		<button onclick="setColor('--on')" class="outline" style="color:white">White</button>
		<button onclick="setColor('--red')" style="color:red">Red</button>
		<button onclick="setColor('--green')" style="color:green">Green</button>
		<button onclick="setColor('--blue')" style="color:blue">Blue</button>
		<button onclick="setColor('--cyan')" class="outline" style="color:cyan">Cyan</button>
		<button onclick="setColor('--magenta')" style="color:magenta">Magenta</button>
		<button onclick="setColor('--yellow')" class="outline" style="color:yellow">Yellow</button>
	</p>

	<pre style="clear:both" id="result"></pre>

	<div id="l1" style="width:300px; height:300px; position:absolute; top:0; left:0; border-bottom: 5px solid white"></div>
	<div id="l2" style="width:300px; height:300px; position:absolute; top:0; right:0; border-bottom: 5px solid white"></div>

	</body>
</html>
